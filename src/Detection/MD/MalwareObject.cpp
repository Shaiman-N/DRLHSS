#include "MalwareObject.h"
#include <iostream>

MalwareObject::MalwareObject(std::shared_ptr<MalwareProcessingPipeline> pipeline)
    : pipeline_(pipeline),
      malwareDetected_(false),
      processingComplete_(false),
      terminated_(false) {
    std::cout << "[MalwareObject] Created" << std::endl;
}

MalwareObject::~MalwareObject() {
    if (!terminated_) {
        terminate();
    }
}

bool MalwareObject::scanFile(const std::string& filePath) {
    if (terminated_) {
        std::cerr << "[MalwareObject] Already terminated" << std::endl;
        return false;
    }
    
    currentFile_ = filePath;
    std::cout << "[MalwareObject] Processing file through pipeline: " << filePath << std::endl;
    
    // Process through complete pipeline
    pipelineResult_ = pipeline_->processFile(filePath);
    
    processingComplete_ = true;
    malwareDetected_ = !pipelineResult_.isSafe;
    
    std::cout << "[MalwareObject] Pipeline processing complete" << std::endl;
    std::cout << "[MalwareObject] Final result: " 
              << (pipelineResult_.isSafe ? "SAFE" : "THREATS DETECTED") << std::endl;
    
    return true;
}

bool MalwareObject::scanDataPacket(const std::vector<uint8_t>& packet) {
    if (terminated_) {
        std::cerr << "[MalwareObject] Already terminated" << std::endl;
        return false;
    }
    
    std::cout << "[MalwareObject] Processing data packet through pipeline (" 
              << packet.size() << " bytes)" << std::endl;
    
    // Process through complete pipeline
    pipelineResult_ = pipeline_->processDataPacket(packet);
    
    processingComplete_ = true;
    malwareDetected_ = !pipelineResult_.isSafe;
    
    std::cout << "[MalwareObject] Pipeline processing complete" << std::endl;
    std::cout << "[MalwareObject] Final result: " 
              << (pipelineResult_.isSafe ? "SAFE" : "THREATS DETECTED") << std::endl;
    
    return true;
}

void MalwareObject::terminate() {
    if (terminated_) {
        return;
    }
    
    std::cout << "[MalwareObject] Terminating - Processing complete for: " 
              << (currentFile_.empty() ? "data packet" : currentFile_) << std::endl;
    
    terminated_ = true;
    
    // Cleanup resources
    currentFile_.clear();
    malwareDetected_ = false;
    processingComplete_ = false;
}
