#pragma once

#include <string>
#include <memory>
#include <vector>
#include <thread>
#include <atomic>
#include <queue>
#include <mutex>
#include <condition_variable>
#include "MalwareDetector.h"
#include "MalwareObject.h"
#include "MalwareProcessingPipeline.h"
#include "SandboxOrchestrator.h"
#include "DRLFramework.h"

struct ScanTask {
    std::string filePath;
    std::vector<uint8_t> data;
    bool isFile;
};

class MalwareDetectionService {
public:
    MalwareDetectionService(const std::string& modelPath, const std::string& databasePath);
    ~MalwareDetectionService();
    
    // Start the background service
    void start();
    
    // Stop the background service
    void stop();
    
    // Queue a file for scanning
    void queueFileScan(const std::string& filePath);
    
    // Queue a data packet for scanning
    void queueDataPacketScan(const std::vector<uint8_t>& packet);
    
    // Check if service is running
    bool isRunning() const { return running_; }
    
private:
    std::shared_ptr<MalwareDetector> detector_;
    std::shared_ptr<DRLFramework> drlFramework_;
    std::shared_ptr<SandboxOrchestrator> orchestrator_;
    std::shared_ptr<MalwareProcessingPipeline> pipeline_;
    
    std::atomic<bool> running_;
    std::thread workerThread_;
    
    std::queue<ScanTask> taskQueue_;
    std::mutex queueMutex_;
    std::condition_variable queueCondition_;
    
    // Worker thread function
    void workerLoop();
    
    // Process a single scan task
    void processScanTask(const ScanTask& task);
};
