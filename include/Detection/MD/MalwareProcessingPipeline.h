#pragma once

#include <string>
#include <vector>
#include <memory>
#include "MalwareDetector.h"
#include "SandboxOrchestrator.h"
#include "DRLFramework.h"

enum class PipelineStage {
    INITIAL_DETECTION,
    POSITIVE_SANDBOX,
    NEGATIVE_SANDBOX,
    COMPLETED,
    ERROR
};

struct PipelineResult {
    bool isSafe;
    PipelineStage finalStage;
    std::vector<std::string> detectedThreats;
    std::vector<uint8_t> cleanedData;
    std::string report;
};

class MalwareProcessingPipeline {
public:
    MalwareProcessingPipeline(
        std::shared_ptr<MalwareDetector> detector,
        std::shared_ptr<SandboxOrchestrator> orchestrator,
        std::shared_ptr<DRLFramework> drlFramework
    );
    ~MalwareProcessingPipeline();
    
    // Process file through complete pipeline
    PipelineResult processFile(const std::string& filePath);
    
    // Process data packet through complete pipeline
    PipelineResult processDataPacket(const std::vector<uint8_t>& packet);
    
    // Send cleaned data to host system
    bool sendToHostSystem(const std::vector<uint8_t>& cleanedData);
    
private:
    std::shared_ptr<MalwareDetector> detector_;
    std::shared_ptr<SandboxOrchestrator> orchestrator_;
    std::shared_ptr<DRLFramework> drlFramework_;
    
    // Pipeline stages
    bool performInitialDetection(const std::string& filePath, float& confidence);
    PipelineResult processWithPositiveSandbox(const std::string& filePath);
    PipelineResult processWithNegativeSandbox(const std::string& filePath, bool fromPositive);
    
    // Helper methods
    std::string generateReport(const std::vector<std::string>& threats, PipelineStage stage);
    void logPipelineProgress(PipelineStage stage, const std::string& filePath);
};
