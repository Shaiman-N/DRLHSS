/**
 * @file MalwareObject.hpp
 * @brief Malware detection object for DRLHSS
 * 
 * Represents a malware detection object that analyzes files/processes
 * Lifecycle: Created → Analyzes (Static + Dynamic) → Reports → Terminates
 * Integrated with DRLHSS DRL, Sandbox, and Database systems
 */

#ifndef DRLHSS_MALWARE_OBJECT_HPP
#define DRLHSS_MALWARE_OBJECT_HPP

#include <string>
#include <vector>
#include <memory>
#include <chrono>
#include <cstdint>

namespace drlhss {
namespace detection {
namespace av {

enum class ThreatLevel {
    BENIGN,
    SUSPICIOUS,
    MALICIOUS,
    UNKNOWN
};

enum class AnalysisPhase {
    CREATED,
    STATIC_ANALYSIS,
    DYNAMIC_ANALYSIS,
    SANDBOX_PENDING,
    DRL_INFERENCE,
    COMPLETED,
    TERMINATED
};

struct AnalysisResult {
    ThreatLevel threat_level;
    float static_confidence;
    float dynamic_confidence;
    float drl_confidence;
    float combined_score;
    std::string verdict;
    std::vector<std::string> indicators;
    std::chrono::milliseconds analysis_duration;
    
    // DRL integration
    int drl_action;  // 0=Allow, 1=Block, 2=Quarantine, 3=DeepScan
    std::vector<float> drl_q_values;
    
    // Sandbox integration
    bool sandbox_analyzed;
    int sandbox_threat_score;
    
    AnalysisResult() : threat_level(ThreatLevel::UNKNOWN),
                      static_confidence(0.0f),
                      dynamic_confidence(0.0f),
                      drl_confidence(0.0f),
                      combined_score(0.0f),
                      verdict("PENDING"),
                      analysis_duration(0),
                      drl_action(-1),
                      sandbox_analyzed(false),
                      sandbox_threat_score(0) {}
};

/**
 * @brief MalwareObject - Core detection object for DRLHSS
 * 
 * Integrates static analysis, dynamic behavior monitoring, DRL inference,
 * and sandbox analysis for comprehensive malware detection.
 */
class MalwareObject {
public:
    /**
     * @brief Constructor
     * @param target_path Path to file or process to analyze
     * @param enable_dynamic Enable dynamic behavior analysis
     * @param enable_drl Enable DRL inference
     */
    explicit MalwareObject(const std::string& target_path, 
                          bool enable_dynamic = false,
                          bool enable_drl = true);
    
    ~MalwareObject();

    // Core analysis methods
    bool analyze();
    bool analyzeStatic();
    bool analyzeDynamic();
    bool analyzeDRL();
    
    // Sandbox integration
    bool sendToSandbox();
    bool waitForSandboxResult();
    
    // State queries
    bool isMalicious() const;
    bool isSuspicious() const;
    bool isAnalysisComplete() const;
    ThreatLevel getThreatLevel() const;
    AnalysisPhase getCurrentPhase() const;
    
    // Results
    const AnalysisResult& getResult() const;
    std::string getReport() const;
    
    // Lifecycle
    void terminate();
    bool isTerminated() const;
    
    // Metadata
    std::string getTargetPath() const { return target_path_; }
    uint64_t getObjectId() const { return object_id_; }
    std::string getFileHash() const { return file_hash_; }
    
private:
    // Internal state
    std::string target_path_;
    std::string file_hash_;
    uint64_t object_id_;
    AnalysisPhase current_phase_;
    bool terminated_;
    bool enable_dynamic_;
    bool enable_drl_;
    
    // Analysis results
    AnalysisResult result_;
    std::vector<float> static_features_;
    std::vector<float> dynamic_features_;
    
    // Timing
    std::chrono::time_point<std::chrono::steady_clock> start_time_;
    
    // Helper methods
    void updatePhase(AnalysisPhase phase);
    void calculateCombinedScore();
    void determineThreatLevel();
    std::string calculateFileHash();
    
    // Static ID counter
    static uint64_t next_object_id_;
};

} // namespace av
} // namespace detection
} // namespace drlhss

#endif // DRLHSS_MALWARE_OBJECT_HPP
